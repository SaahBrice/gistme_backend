{% extends 'web/base.html' %}
{% load static %}

{% block title %}{{ article.title|default:"Article" }} - Gist4U{% endblock %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'web/css/article.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Open Graph Meta Tags for Rich Sharing -->
<meta property="og:title" content="{{ article.title|default:'Gist4U Article' }}">
<meta property="og:description" content="{{ article.description|default:'Read the latest news and opportunities on Gist4U'|truncatechars:160 }}">
<meta property="og:image" content="{{ article.thumbnail|default:'https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=800' }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Gist4U">

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ article.title|default:'Gist4U Article' }}">
<meta name="twitter:description" content="{{ article.description|default:'Read the latest news and opportunities on Gist4U'|truncatechars:160 }}">
<meta name="twitter:image" content="{{ article.thumbnail|default:'https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=800' }}">
{% endblock %}

{% block content %}
<div class="article-page" x-data="articleApp()" x-init="init()">
    
    <!-- Top Navigation -->
    <nav class="article-top-nav">
        <button class="back-btn" @click="goBack()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
        </button>
    </nav>
    
    <!-- Article Content -->
    <div class="article-content-wrapper">
        
        <!-- Hero Section -->
        <header class="article-hero">
            <img class="article-hero-image" 
                 :src="article?.thumbnail || 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=800'"
                 :alt="article?.title"
                 loading="eager">
            
            <div class="article-hero-overlay"></div>
            
            <div class="article-hero-content">
                <span class="article-category-badge" x-text="article?.headline || 'NEWS'"></span>
                <h1 class="article-title" x-text="article?.title">Article Title</h1>
                
                <div class="article-meta">
                    <span class="article-meta-item" x-text="article?.published_date">Date</span>
                    <span class="article-meta-dot"></span>
                    <span class="article-meta-item" x-text="article?.read_time">Read time</span>
                    <span class="article-meta-dot"></span>
                    <span class="article-meta-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <span x-text="article?.view_count?.toLocaleString()">0</span>
                    </span>
                </div>
            </div>
        </header>
        
        <!-- Article Body -->
        <article class="article-body">
            <!-- Language Switcher -->
            <div class="language-switcher">
                <button class="lang-btn active">EN</button>
                <button class="lang-btn">FR</button>
            </div>
            
            <!-- Article Description / Content -->
            <div class="article-description">
                <p x-text="article?.description">Article content goes here...</p>
            </div>
            
            <!-- Related Articles Section -->
            <section class="related-articles-section">
                <div class="related-articles-header">
                    <h3 class="related-articles-title">More for you</h3>
                </div>
                
                <div class="related-articles-scroll">
                    <template x-for="related in relatedArticles" :key="related.id">
                        <article class="related-article-card" @click="goToArticle(related.id)">
                            <img class="related-article-image" 
                                 :src="related.thumbnail" 
                                 :alt="related.title"
                                 loading="lazy">
                            <div class="related-article-content">
                                <h4 class="related-article-title" x-text="related.title"></h4>
                            </div>
                        </article>
                    </template>
                </div>
            </section>
            
            <!-- Timeline Section -->
            <section class="timeline-section">
                <h3 class="timeline-title">Timeline</h3>
                
                <div class="timeline-flow">
                    <template x-for="(item, index) in timelineItems" :key="item.id">
                        <div class="timeline-item" :class="{ 'first': index === 0 }">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content" @click="goToArticle(item.id)">
                                <span class="timeline-date" x-text="item.date"></span>
                                <h4 class="timeline-item-title" x-text="item.title"></h4>
                                <span class="timeline-category" x-text="item.category"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </section>
        </article>
    </div>
    
    <!-- Fixed Bottom Navigation Bar - Inline Chat Layout -->
    <nav class="article-bottom-nav">
        
        <!-- Left: Chat Input -->
        <div class="nav-chat-input-group">
            <input type="text" 
                   class="nav-chat-input" 
                   placeholder="Ask follow-up..."
                   x-model="chatInput"
                   @keydown.enter="sendQuickMessage()"
                   @focus="onInputFocus()">
            <button class="nav-send-btn" 
                    @click="sendQuickMessage()"
                    title="Send">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
        
        <!-- Center: Play Button -->
        <div class="nav-play-center">
            <div class="play-blob-container">
                <button class="play-blob" 
                        :class="{ 'playing': isPlaying }"
                        @click="togglePlay()"
                        title="Play/Pause Audio">
                    <span class="play-blob-icon">
                        <svg x-show="!isPlaying" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                            <polygon points="6 3 20 12 6 21 6 3"/>
                        </svg>
                        <svg x-show="isPlaying" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                            <rect x="6" y="4" width="4" height="16" rx="1"/>
                            <rect x="14" y="4" width="4" height="16" rx="1"/>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
        
        <!-- Right: Share & Bookmark -->
        <div class="nav-actions-group">
            <button class="nav-action-btn" @click="openShareModal()" title="Share">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
            </button>
            
            <button class="nav-action-btn" 
                    :class="{ 'active': isBookmarked }"
                    @click="toggleBookmark()"
                    title="Bookmark">
                <svg viewBox="0 0 24 24" :fill="isBookmarked ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                </svg>
            </button>
        </div>
        
    </nav>
    
    <!-- Share Modal -->
    <div class="share-modal-backdrop" 
         x-show="showShareModal"
         x-transition:enter="fade-enter-active"
         x-transition:leave="fade-leave-active"
         @click="closeShareModal()">
    </div>
    
    <div class="share-modal"
         x-show="showShareModal"
         x-transition:enter="slide-up-enter-active"
         x-transition:enter-start="slide-up-enter"
         x-transition:leave="slide-up-leave-active"
         @click.outside="closeShareModal()">
        
        <div class="share-modal-handle"></div>
        <h2 class="share-modal-title">Share this article</h2>
        
        <!-- Share Options -->
        <div class="share-options">
            <button class="share-option-btn" @click="copyLink()">
                <div class="share-option-icon copy">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                </div>
                <span class="share-option-label" x-text="linkCopied ? 'Copied!' : 'Copy'"></span>
            </button>
            
            <button class="share-option-btn" @click="generateShareImage()">
                <div class="share-option-icon image">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                </div>
                <span class="share-option-label">Image</span>
            </button>
            
            <button class="share-option-btn" @click="shareToWhatsApp()">
                <div class="share-option-icon whatsapp">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
                    </svg>
                </div>
                <span class="share-option-label">WhatsApp</span>
            </button>
            
            <button class="share-option-btn" @click="shareToTwitter()">
                <div class="share-option-icon twitter">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </div>
                <span class="share-option-label">X</span>
            </button>
        </div>
        
        <!-- Share Link Input -->
        <div class="share-link-container">
            <input type="text" class="share-link-input" :value="getShareUrl()" readonly>
            <button class="share-link-copy-btn" 
                    :class="{ 'copied': linkCopied }"
                    @click="copyLink()"
                    x-text="linkCopied ? 'âœ“' : 'Copy'">
            </button>
        </div>
        
        <!-- Image Preview (shown after generation) -->
        <div class="share-image-preview" x-show="shareImageUrl">
            <img :src="shareImageUrl" alt="Share preview">
            <button class="share-download-btn" @click="downloadShareImage()">
                Download Image
            </button>
        </div>
    </div>
    
    <!-- AI Chat Modal -->
    <div class="chat-modal-backdrop"
         x-show="showChatModal"
         x-transition:enter="fade-enter-active"
         x-transition:leave="fade-leave-active"
         @click="closeChatModal()">
    </div>
    
    <div class="chat-modal"
         x-show="showChatModal"
         x-transition:enter="slide-up-enter-active"
         x-transition:enter-start="slide-up-enter"
         x-transition:leave="slide-up-leave-active"
         @click.outside="closeChatModal()">
        
        <!-- Chat Header -->
        <div class="chat-modal-header">
            <div class="chat-modal-title-area">
                <div class="chat-ai-avatar">ðŸ¤–</div>
                <div>
                    <h3 class="chat-modal-title">Gist Assistant</h3>
                    <p class="chat-modal-subtitle">Ask me about this article</p>
                </div>
            </div>
            <button class="chat-close-btn" @click="closeChatModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
        <!-- Quick Questions -->
        <div class="chat-quick-questions">
            <template x-for="question in quickQuestions" :key="question">
                <button class="quick-question-chip" @click="sendQuickQuestion(question)" x-text="question"></button>
            </template>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages">
            <template x-for="message in chatMessages" :key="message.id">
                <div class="chat-message" :class="message.role">
                    <div class="chat-avatar">
                        <template x-if="message.role === 'assistant'">
                            <span>ðŸ¤–</span>
                        </template>
                        <template x-if="message.role === 'user'">
                            <span>U</span>
                        </template>
                    </div>
                    <div class="chat-bubble">
                        <span x-text="message.content"></span>
                        <div class="chat-bubble-time" x-text="message.timestamp"></div>
                    </div>
                </div>
            </template>
            
            <!-- Typing Indicator -->
            <div class="chat-message assistant" x-show="isTyping">
                <div class="chat-avatar">ðŸ¤–</div>
                <div class="chat-bubble">
                    <div class="chat-typing">
                        <span class="chat-typing-dot"></span>
                        <span class="chat-typing-dot"></span>
                        <span class="chat-typing-dot"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-container">
            <input type="text" 
                   class="chat-input" 
                   placeholder="Ask about this article..."
                   x-model="chatInput"
                   @keydown="handleChatKeydown($event)">
            <button class="chat-send-btn" 
                    @click="sendMessage()"
                    :disabled="!chatInput.trim()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="article-toast" 
         :class="toastType"
         x-show="showToast"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-4">
        <span x-text="toastType === 'success' ? 'âœ…' : 'â„¹ï¸'"></span>
        <span x-text="toastMessage"></span>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'web/js/article-dummy-data.js' %}"></script>
<script src="{% static 'web/js/article.js' %}"></script>
{% endblock %}
