{% extends 'web/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Search" %} - Gist4U{% endblock %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'web/css/feed.css' %}">
<link rel="stylesheet" href="{% static 'web/css/search.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="search-page" x-data="searchApp()" x-init="init()">
    {% csrf_token %}
    
    <!-- Search Header -->
    <header class="search-header">
        <button class="back-btn" @click="goBack()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
            </svg>
        </button>
        
        <div class="search-input-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" 
                   class="search-input" 
                   x-model="query" 
                   @input.debounce.300ms="performSearch()"
                   @keydown.enter="performSearch()"
                   placeholder="{% trans 'Search articles...' %}"
                   autofocus>
            <button class="clear-btn" x-show="query.length > 0" @click="clearSearch()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
    </header>
    
    <!-- Search Results -->
    <main class="search-results">
        <!-- Loading state -->
        <div class="loading-state" x-show="isLoading">
            <div class="loader"></div>
            <p>{% trans "Searching..." %}</p>
        </div>
        
        <!-- Empty state (before searching) -->
        <div class="empty-state" x-show="!isLoading && results.length === 0 && !hasSearched">
            <div class="empty-icon">üîç</div>
            <h2>{% trans "Find what interests you" %}</h2>
            <p>{% trans "Search for news, scholarships, jobs, and more" %}</p>
        </div>
        
        <!-- No results state -->
        <div class="empty-state" x-show="!isLoading && results.length === 0 && hasSearched">
            <div class="empty-icon">üòî</div>
            <h2>{% trans "No results found" %}</h2>
            <p>{% trans "Try different keywords or check your spelling" %}</p>
        </div>
        
        <!-- Results list -->
        <div class="results-list" x-show="!isLoading && results.length > 0">
            <template x-for="article in results" :key="article.id">
                <a :href="getArticleUrl(article)" class="result-card">
                    <img :src="getArticleImage(article)" :alt="getArticleTitle(article)" class="result-image" loading="lazy">
                    <div class="result-content">
                        <span class="result-category" x-text="getCategoryName(article)"></span>
                        <h3 class="result-title" x-text="getArticleTitle(article)"></h3>
                        <p class="result-excerpt" x-text="getArticleExcerpt(article)"></p>
                    </div>
                </a>
            </template>
            
            <!-- Load more button -->
            <button class="load-more-btn" 
                    x-show="hasNextPage" 
                    @click="loadMore()"
                    :disabled="isLoadingMore">
                <span x-show="!isLoadingMore">{% trans "Load More" %}</span>
                <span x-show="isLoadingMore">{% trans "Loading..." %}</span>
            </button>
        </div>
    </main>
</div>

<script>
function searchApp() {
    return {
        query: '',
        results: [],
        isLoading: false,
        isLoadingMore: false,
        hasSearched: false,
        hasNextPage: false,
        currentPage: 1,
        
        get lang() {
            const match = window.location.pathname.match(/^\/(en|fr)\//);
            return match ? match[1] : 'en';
        },
        
        init() {
            // Check for query param
            const urlParams = new URLSearchParams(window.location.search);
            const q = urlParams.get('q');
            if (q) {
                this.query = q;
                this.performSearch();
            }
        },
        
        goBack() {
            if (document.referrer && document.referrer.includes(window.location.host)) {
                window.history.back();
            } else {
                window.location.href = `/${this.lang}/feed/`;
            }
        },
        
        clearSearch() {
            this.query = '';
            this.results = [];
            this.hasSearched = false;
        },
        
        async performSearch() {
            if (this.query.trim().length < 2) {
                this.results = [];
                this.hasSearched = false;
                return;
            }
            
            this.isLoading = true;
            this.hasSearched = true;
            this.currentPage = 1;
            
            try {
                const response = await fetch(`/api/articles/?search=${encodeURIComponent(this.query)}&page=1&page_size=15`);
                if (response.ok) {
                    const data = await response.json();
                    this.results = data.results || data;
                    this.hasNextPage = data.next !== null;
                }
            } catch (e) {
                console.error('Search failed:', e);
            } finally {
                this.isLoading = false;
            }
        },
        
        async loadMore() {
            if (this.isLoadingMore || !this.hasNextPage) return;
            
            this.isLoadingMore = true;
            this.currentPage++;
            
            try {
                const response = await fetch(`/api/articles/?search=${encodeURIComponent(this.query)}&page=${this.currentPage}&page_size=15`);
                if (response.ok) {
                    const data = await response.json();
                    this.results = [...this.results, ...(data.results || data)];
                    this.hasNextPage = data.next !== null;
                }
            } catch (e) {
                console.error('Load more failed:', e);
            } finally {
                this.isLoadingMore = false;
            }
        },
        
        getArticleUrl(article) {
            return `/${this.lang}/article/${article.id}/`;
        },
        
        getArticleTitle(article) {
            return this.lang === 'fr' 
                ? (article.headline_fr || article.headline_en || article.headline)
                : (article.headline_en || article.headline_fr || article.headline);
        },
        
        getArticleExcerpt(article) {
            return this.lang === 'fr' 
                ? (article.french_summary || article.english_summary)
                : (article.english_summary || article.french_summary);
        },
        
        getArticleImage(article) {
            if (article.thumbnails && article.thumbnails.length > 0) {
                return article.thumbnails[0];
            }
            return 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=400&h=300&fit=crop';
        },
        
        getCategoryName(article) {
            if (!article.category_details) return '';
            const cat = article.category_details;
            const name = this.lang === 'fr' ? cat.name_fr : cat.name_en;
            return cat.emoji ? `${cat.emoji} ${name}` : name;
        }
    }
}
</script>
{% endblock %}
