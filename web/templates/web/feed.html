{% extends 'web/base.html' %}
{% load static %}

{% block title %}Feed - Gist4U{% endblock %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'web/css/feed.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="feed-page" x-data="feedApp()" x-init="init()">
    
    <!-- Feed Cards - Snap Scroll Container -->
    <main class="feed-content" id="feed-scroll" @scroll="onScroll($event)">
        <!-- Top spacer for breathing room -->
        <div class="feed-spacer"></div>
        <template x-for="(article, index) in filteredArticles" :key="article.id">
            <article class="feed-card" 
                     :class="{ 'card-active': activeCardIndex === index }"
                     :style="getCardStyle(index)"
                     @click="openArticle(article)">
                <div class="card-image">
                    <img :src="article.image" :alt="article.title" loading="lazy">
                </div>
                
                <div class="card-content">
                    <h3 class="card-title" x-text="article.title"></h3>
                    <p class="card-excerpt" x-text="article.excerpt"></p>
                </div>
                
                <div class="card-actions" @click.stop>
                    <button class="action-btn" @click="playArticle(article)"
                            :class="{ 'playing': playingId === article.id }">
                        <svg x-show="playingId !== article.id" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        <svg x-show="playingId === article.id" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>
                    </button>
                    
                    <div class="actions-right">
                        <button class="action-btn" @click="shareArticle(article)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                        </button>
                        <button class="action-btn" @click="toggleBookmark(article)" 
                                :class="{ 'active': article.bookmarked }">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </article>
        </template>
    </main>
    
    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        
        <!-- Sub-category Chips (appear above main nav when active) -->
        <div class="sub-chips-container" 
             x-show="showSubChips"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             @mouseover="resetNavTimeout()"
             @touchstart="resetNavTimeout()">
            <div class="sub-chips">
                <template x-for="cat in currentCategories" :key="cat.id">
                    <button class="sub-chip" 
                            :class="{ 'active': activeCategory === cat.id }"
                            @click="setCategory(cat.id)">
                        <span x-text="cat.name"></span>
                    </button>
                </template>
            </div>
        </div>
        
        <!-- Main Tab Chips (appear when expanded) -->
        <div class="nav-chips-wrapper" 
             x-show="navExpanded"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0 translate-y-4"
             @mouseover="resetNavTimeout()"
             @touchstart="resetNavTimeout()">
            <div class="nav-chips">
                <button class="nav-chip" 
                        :class="{ 'active': activeTab === 'news' }"
                        @click="setTab('news')">
                    News
                </button>
                <button class="nav-chip" 
                        :class="{ 'active': activeTab === 'opportunities' }"
                        @click="setTab('opportunities')">
                    Opportunities
                </button>
                <button class="nav-chip" 
                        :class="{ 'active': activeTab === 'foryou' }"
                        @click="setTab('foryou')">
                    For You
                </button>
            </div>
        </div>
        
        <!-- Bottom Bar Controls -->
        <div class="nav-bar">
            <!-- Left: Profile + Notification in oval pill -->
            <div class="nav-left-pill">
                <div class="profile-avatar" @click="showProfile = true">
                    <span class="avatar-letter">{{ user.first_name|default:user.email|slice:":1"|upper }}</span>
                </div>
                <button class="notification-btn" @click="showNotifications = true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span class="notification-dot" x-show="hasNewNotifications"></span>
                </button>
            </div>
            
            <!-- Right: Expand Button (menu icon) -->
            <button class="expand-btn" 
                    @click="toggleNav()"
                    :class="{ 'expanded': navExpanded }">
                <!-- Grid/menu icon when collapsed, X when expanded -->
                <svg x-show="!navExpanded" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
                <svg x-show="navExpanded" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
    </div>
    
    <!-- Profile Modal -->
    <div class="modal-backdrop" 
         x-show="showProfile" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="showProfile = false">
    </div>
    
    <div class="profile-modal" 
         x-show="showProfile"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-y-8"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-8"
         @click.outside="showProfile = false">
        
        <div class="profile-modal-content">
            <!-- User Profile Header -->
            <div class="profile-header">
                <div class="profile-header-avatar">
                    {{ user.first_name|default:user.email|slice:":1"|upper }}
                </div>
                <div class="profile-header-info">
                    <span class="profile-greeting">Hey, {{ user.first_name|default:user.email|slice:":6" }}! üëã</span>
                    <span class="profile-name">{{ user.email }}</span>
                </div>
            </div>
            
            <div class="profile-divider"></div>
            
            <!-- My Quote of Today -->
            <button class="profile-menu-item" @click="alert('Coming soon!')">
                <div class="menu-icon quote-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21"/>
                        <path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3"/>
                    </svg>
                </div>
                <span>My Quote of Today</span>
            </button>
            
            <!-- Relax Here -->
            <a href="/relax/" class="profile-menu-item" @click="showProfile = false">
                <div class="menu-icon relax-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                    </svg>
                </div>
                <span>Relax Here</span>
            </a>
            
            <!-- Mentor Me -->
            <button class="profile-menu-item" @click="alert('Coming soon!')">
                <div class="menu-icon mentor-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <span>Mentor Me</span>
            </button>
            
            <!-- Mentors, Sponsors & Partners -->
            <button class="profile-menu-item" @click="alert('Coming soon!')">
                <div class="menu-icon partners-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <span>Mentors, Sponsors & Partners</span>
            </button>
            
            <!-- Bookmarks -->
            <button class="profile-menu-item" @click="alert('Coming soon!')">
                <div class="menu-icon bookmarks-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <span>Bookmarks</span>
            </button>
            
            <!-- Settings -->
            <button class="profile-menu-item" @click="openSettings()">
                <div class="menu-icon settings-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </div>
                <span>Settings</span>
            </button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-backdrop" 
         x-show="showSettings" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="showSettings = false">
    </div>
    
    <div class="settings-modal" 
         x-show="showSettings"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-x-8"
         x-transition:enter-end="opacity-100 translate-x-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-x-0"
         x-transition:leave-end="opacity-0 translate-x-8"
         @click.outside="showSettings = false">
        
        <!-- Header -->
        <div class="settings-header">
            <button class="settings-back-btn" @click="showSettings = false; showProfile = true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </button>
            <span class="settings-title">Settings</span>
        </div>
        
        <div class="settings-content">
            <!-- Account Section -->
            <div class="settings-section">
                <div class="settings-section-label">üì± Account</div>
                <div class="settings-field">
                    <label>Name</label>
                    <input type="text" x-model="settingsName" placeholder="Your name">
                </div>
                <div class="settings-field">
                    <label>Phone</label>
                    <input type="tel" x-model="settingsPhone" placeholder="+237 6XXXXXXXX">
                </div>
                <div class="settings-field">
                    <label>Email</label>
                    <input type="email" value="{{ user.email }}" disabled>
                </div>
                <div class="settings-field">
                    <label>Region</label>
                    <select x-model="settingsRegion">
                        <option value="">Select...</option>
                        <option value="ADAMAWA">Adamawa</option>
                        <option value="CENTRE">Centre</option>
                        <option value="EAST">East</option>
                        <option value="FAR_NORTH">Far North</option>
                        <option value="LITTORAL">Littoral</option>
                        <option value="NORTH">North</option>
                        <option value="NORTHWEST">Northwest</option>
                        <option value="SOUTH">South</option>
                        <option value="SOUTHWEST">Southwest</option>
                        <option value="WEST">West</option>
                    </select>
                </div>
            </div>
            
            <!-- Notifications Section -->
            <div class="settings-section">
                <div class="settings-section-label">üîî Notifications</div>
                <div class="settings-field">
                    <label>Notification Time</label>
                    <select x-model="settingsNotifTime">
                        <option value="06:00">6:00 AM</option>
                        <option value="08:00">8:00 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="18:00">6:00 PM</option>
                    </select>
                </div>
                <div class="settings-toggle-row">
                    <span>Push Notifications</span>
                    <div class="settings-toggle" :class="{ 'active': pushEnabled }" @click="pushEnabled = !pushEnabled"></div>
                </div>
            </div>
            
            <!-- Preferences Section -->
            <div class="settings-section">
                <div class="settings-section-label">üé® Preferences</div>
                <div class="settings-field">
                    <label>Language</label>
                    <select x-model="settingsLanguage">
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                    </select>
                </div>
            </div>
            
            <!-- Save Button -->
            <button class="settings-save-btn" @click="saveSettings()" :disabled="savingSettings">
                <span x-show="!savingSettings">Save Changes</span>
                <span x-show="savingSettings">Saving...</span>
            </button>
            
            <!-- Actions Section -->
            <div class="settings-section">
                <div class="settings-section-label">üîí Account Actions</div>
                <button class="settings-action-btn" @click="window.location.href='/accounts/logout/'">
                    Log Out
                </button>
                <button class="settings-action-btn danger" @click="showDeletePopup = true">
                    Delete Account
                </button>
                <button class="settings-action-btn" @click="showSettings = false; showTerms = true">
                    Terms & Privacy Policy
                </button>
            </div>
            
            <div class="settings-version">Gist4U v1.0.0</div>
        </div>
    </div>
    
    <!-- Terms Modal -->
    <div class="modal-backdrop" 
         x-show="showTerms"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         @click="showTerms = false">
    </div>
    
    <div class="settings-modal terms-modal" 
         x-show="showTerms"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-x-8"
         x-transition:enter-end="opacity-100 translate-x-0">
        
        <div class="settings-header">
            <button class="settings-back-btn" @click="showTerms = false; showSettings = true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </button>
            <span class="settings-title">Terms & Privacy</span>
        </div>
        
        <div class="settings-content terms-content">
            <h3>Terms of Service</h3>
            <p>By using Gist4U, you agree to these terms. We provide curated opportunities including scholarships, jobs, and competitions.</p>
            
            <h3>Privacy Policy</h3>
            <p>We collect your email, phone, and preferences to personalize your experience. Your data is stored securely and never sold.</p>
            
            <h3>Notifications</h3>
            <p>By enabling notifications, you consent to receiving updates about opportunities matching your interests.</p>
            
            <h3>Contact</h3>
            <p>Questions? Email us at <strong>gist4u@gmail.com</strong></p>
        </div>
    </div>
    
    <!-- Delete Account Popup -->
    <div class="delete-popup-overlay" x-show="showDeletePopup" x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100">
        <div class="delete-popup">
            <div class="delete-popup-icon">‚ö†Ô∏è</div>
            <div class="delete-popup-title">Delete Account?</div>
            <p class="delete-popup-text">To delete your account, contact us:</p>
            <div class="delete-popup-email">gist4u@gmail.com</div>
            <button class="delete-popup-close" @click="showDeletePopup = false">Got it</button>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'web/js/feed.js' %}"></script>
{% endblock %}
