{% extends 'web/base.html' %}
{% load static %}

{% block title %}Welcome - Gist4U{% endblock %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'web/css/onboarding.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Carter+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="onboarding-page" x-data="onboardingFlow()" x-init="init()">
    
    <!-- Tech Mesh Background -->
    <canvas id="mesh-canvas"></canvas>
    
    <div class="onboarding-content">
        <div class="onboarding-header">
            <div class="header-row">
                <div class="onboarding-logo">Gist4U</div>
                <button class="audio-play-btn" @click="showPlayer = true; playAudio()" title="Listen to intro">
                </button>
            </div>
            <p class="onboarding-subtitle">Let's personalize your experience</p>
            
            <div class="onboarding-progress">
                <template x-for="i in 5" :key="i">
                    <div class="progress-dot" 
                         :class="{ 'active': step === i, 'completed': step > i }"></div>
                </template>
            </div>
        </div>
        
        <!-- Audio Player Modal -->
        <div class="audio-modal-overlay" x-show="showPlayer" x-transition.opacity>
            <div class="audio-modal" x-show="showPlayer" x-transition.scale.origin.center>
                <div class="audio-blob-container" :class="{ 'celebrating': audioComplete }">
                    <!-- Progress Ring -->
                    <svg class="progress-ring" viewBox="0 0 130 130">
                        <circle class="progress-ring-circle" cx="65" cy="65" r="60"/>
                        <circle class="progress-ring-progress" cx="65" cy="65" r="60" 
                                :style="{ strokeDashoffset: 377 - (377 * audioProgress / 100) }"/>
                    </svg>
                    <div class="audio-blob" :class="{ 'playing': isPlaying, 'complete': audioComplete }"></div>
                    
                    <!-- Celebration Particles -->
                    <template x-if="audioComplete">
                        <div class="particles">
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                        </div>
                    </template>
                </div>
                
                <p class="audio-modal-text" x-text="audioComplete ? 'üéâ You\'re ready!' : 'Your future matters to us!!!'"></p>
                
                <div class="audio-modal-buttons">
                    <button class="btn-play" @click="playOrReplay()" x-text="hasStartedPlaying ? 'Replay' : 'Play'">
                        Play
                    </button>
                    <button class="btn-letsgo" @click="closePlayer()" :disabled="audioProgress < 50" 
                            :class="{ 'disabled': audioProgress < 50, 'pulse-active': audioComplete }">
                        Let's Go ‚Üí
                    </button>
                </div>
            </div>
        </div>
        
        <audio id="onboarding-audio" src="{% static 'web/audio/gist4u_onboarding_message_en.mp3' %}" preload="auto"></audio>
        
        <div class="step-container">
            <!-- Step 1: Phone Number & Region -->
            <div class="step-card" x-show="step === 1">
                <div class="step-emoji">üì±</div>
                <h2 class="step-title">Let's get started</h2>
                <p class="step-subtitle">Your phone & where you're based</p>
                
                <div class="phone-input-group">
                    <span class="phone-prefix">+237</span>
                    <input type="tel" 
                           class="phone-input" 
                           placeholder="6XXXXXXXX"
                           x-model="phone"
                           maxlength="9"
                           @input="validatePhone()">
                </div>
                <p class="error-text" x-show="phoneError" x-text="phoneError"></p>
                
                <label class="group-label">Your Region</label>
                <div class="region-grid">
                    <template x-for="option in regionOptions" :key="option.value">
                        <div class="region-chip" 
                             :class="{ 'selected': region === option.value }"
                             @click="region = option.value"
                             x-text="option.label"></div>
                    </template>
                </div>
                
                <div class="step-nav">
                    <button class="btn-next" @click="nextStep()" :disabled="!isPhoneValid || !region">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Interests -->
            <div class="step-card" x-show="step === 2">
                <div class="step-emoji">üéØ</div>
                <h2 class="step-title">What interests you?</h2>
                <p class="step-subtitle">Select all that apply</p>
                
                <div class="chips-container">
                    <div class="chips-grid">
                        <!-- Select All at the TOP -->
                        <div class="chip chip-full" 
                             :class="{ 'selected': interests.length === interestOptions.length }"
                             @click="selectAllInterests()">
                            <span class="chip-emoji">‚úÖ</span>
                            <span>Select All</span>
                        </div>
                        
                        <template x-for="option in interestOptions" :key="option.id">
                            <div class="chip" 
                                 :class="{ 'selected': interests.includes(option.id) }"
                                 @click="toggleInterest(option.id)">
                                <span class="chip-emoji" x-text="option.emoji"></span>
                                <span x-text="option.label"></span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="step-nav">
                    <button class="btn-back" @click="prevStep()">‚Üê</button>
                    <button class="btn-next" @click="nextStep()" :disabled="interests.length === 0">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Education & Background -->
            <div class="step-card" x-show="step === 3">
                <div class="step-emoji">üéì</div>
                <h2 class="step-title">About You</h2>
                <p class="step-subtitle">This helps us find relevant opportunities</p>
                
                <p class="section-label">Highest Education</p>
                <div class="pills-container">
                    <template x-for="option in educationOptions" :key="option.value">
                        <div class="pill" 
                             :class="{ 'selected': education === option.value }"
                             @click="education = option.value"
                             x-text="option.label"></div>
                    </template>
                </div>
                
                <div class="section-divider"></div>
                
                <p class="section-label">Your Background</p>
                <div class="pills-container">
                    <template x-for="option in backgroundOptions" :key="option.value">
                        <div class="pill" 
                             :class="{ 'selected': background === option.value }"
                             @click="background = option.value"
                             x-text="option.label"></div>
                    </template>
                </div>
                
                <div class="step-nav">
                    <button class="btn-back" @click="prevStep()">‚Üê</button>
                    <button class="btn-next" @click="nextStep()" :disabled="!education || !background">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Notification Time -->
            <div class="step-card" x-show="step === 4">
                <div class="step-emoji">üîî</div>
                <h2 class="step-title">When to notify you?</h2>
                <p class="step-subtitle">Pick your preferred time</p>
                
                <div class="time-picker">
                    <template x-for="slot in timeSlots" :key="slot.value">
                        <div class="time-slot" 
                             :class="{ 'selected': notificationTime === slot.value }"
                             @click="notificationTime = slot.value">
                            <div class="time-slot-time" x-text="slot.time"></div>
                            <div class="time-slot-label" x-text="slot.label"></div>
                        </div>
                    </template>
                </div>
                
                <div class="step-nav">
                    <button class="btn-back" @click="prevStep()">‚Üê</button>
                    <button class="btn-next" @click="nextStep()" :disabled="!notificationTime">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Custom Desires (Optional) -->
            <div class="step-card" x-show="step === 5">
                <div class="step-emoji">üí≠</div>
                <h2 class="step-title">Anything else?</h2>
                <p class="step-subtitle">Tell us your specific needs (optional)</p>
                
                <textarea class="desires-textarea" 
                          x-model="customDesires"
                          placeholder="E.g., I'm looking for Master's scholarships in Canada for Computer Science..."></textarea>
                <p class="desires-hint">Be specific! This helps us find exactly what you need.</p>
                
                <div class="step-nav">
                    <button class="btn-back" @click="prevStep()">‚Üê</button>
                    <button class="btn-next btn-save" @click="saveAndContinue()" :disabled="saving">
                        <span x-show="!saving">Save & Go ‚Üí</span>
                        <span x-show="saving">Saving...</span>
                    </button>
                </div>
                
                <div class="skip-optional" x-show="!customDesires">
                    <button @click="saveAndContinue()">Skip for now</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'web/js/onboarding.js' %}"></script>
{% endblock %}
